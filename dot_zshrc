# ============================================================================
# Zsh Configuration
# Ghostty + tmux + AI CLI Development Environment
# ============================================================================

# ----------------------------------------------------------------------------
# 성능 측정 (시작)
# ----------------------------------------------------------------------------
zmodload zsh/datetime
zsh_start_time=$EPOCHREALTIME

# ----------------------------------------------------------------------------
# 환경 변수 (PATH는 .zshenv에서 관리)
# ----------------------------------------------------------------------------
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export EDITOR="vim"
export VISUAL="vim"
export DOTFILES_DIR="$HOME/.local/share/chezmoi"

# ----------------------------------------------------------------------------
# 히스토리 설정
# ----------------------------------------------------------------------------
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
setopt HIST_IGNORE_DUPS      # 연속 중복 무시
setopt HIST_IGNORE_ALL_DUPS  # 전체 중복 제거
setopt HIST_REDUCE_BLANKS    # 불필요한 공백 제거
setopt SHARE_HISTORY         # 세션 간 히스토리 공유
setopt HIST_IGNORE_SPACE     # 공백 시작 명령 무시 (비밀 명령용)

# ----------------------------------------------------------------------------
# Antidote (Zsh 플러그인 매니저)
# ----------------------------------------------------------------------------
source /opt/homebrew/opt/antidote/share/antidote/antidote.zsh
antidote load

# ----------------------------------------------------------------------------
# Starship Prompt
# ----------------------------------------------------------------------------
eval "$(starship init zsh)"

# ----------------------------------------------------------------------------
# NVM (Node Version Manager) — 지연 로딩 (~200ms 절약)
# ----------------------------------------------------------------------------
export NVM_DIR="$HOME/.nvm"
nvm() {
    unfunction nvm node npm npx 2>/dev/null
    [ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"
    [ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && \. "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"
    nvm "$@"
}
node()  { nvm; command node "$@"; }
npm()   { nvm; command npm "$@"; }
npx()   { nvm; command npx "$@"; }

# ----------------------------------------------------------------------------
# Bun
# ----------------------------------------------------------------------------
# Bun completions (PATH는 .zshenv에서 관리)
# ----------------------------------------------------------------------------
[ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"

# ----------------------------------------------------------------------------
# Completions (compinit 1회만 호출, 1일 1회 캐시 갱신)
# ----------------------------------------------------------------------------
fpath=($HOME/.docker/completions $fpath)
autoload -Uz compinit
if [[ -n ~/.zcompdump(#qN.mh+24) ]]; then
    compinit
else
    compinit -C
fi

# ----------------------------------------------------------------------------
# Fastfetch (시스템 정보) - Claude Code 외부에서만
# ----------------------------------------------------------------------------
if command -v fastfetch > /dev/null 2>&1 && [[ -z "$CLAUDE_CODE" ]]; then
    fastfetch
fi

# ============================================================================
# 별칭 (Aliases)
# ============================================================================

# ----------------------------------------------------------------------------
# tmux 통합 함수 (t)
# 사용법: t [command|session-name]
# ----------------------------------------------------------------------------
t() {
    local cmd="${1:-}"

    case "$cmd" in
        # 개발 세션 (nvim + AI + Shell)
        dev)
            shift
            local session_name="${1:-$(basename $PWD)}"
            if tmux has-session -t "$session_name" 2>/dev/null; then
                echo "󰆍 세션 '$session_name' 연결..."
                tmux attach -t "$session_name"
            else
                echo "󰆍 개발 세션 '$session_name' 시작..."
                tmux new-session -d -s "$session_name" -n nvim -c "#{pane_current_path}"
                tmux send-keys -t "$session_name:nvim" "nvim" Enter
                tmux new-window -t "$session_name" -n AI
                tmux split-window -t "$session_name:AI" -h
                tmux send-keys -t "$session_name:AI.0" "claude" Enter
                tmux send-keys -t "$session_name:AI.1" "codex" Enter
                tmux new-window -t "$session_name" -n shell
                tmux select-window -t "$session_name:nvim"
                tmux attach -t "$session_name"
            fi
            ;;

        # 세션 관리
        ls|list)
            tmux list-sessions 2>/dev/null || echo "세션 없음"
            ;;
        a|attach)
            shift
            if [[ -z "$1" ]]; then
                if command -v fzf > /dev/null 2>&1; then
                    local session=$(tmux list-sessions -F '#S' 2>/dev/null | fzf --prompt="세션 선택: ")
                    [[ -n "$session" ]] && tmux attach -t "$session"
                else
                    tmux list-sessions
                fi
            else
                tmux attach -t "$@"
            fi
            ;;
        k|kill)
            shift
            tmux kill-session -t "$@"
            ;;
        ka|kill-all)
            tmux kill-server
            ;;

        # 도움말
        -h|--help|help)
            cat << 'EOF'
t - tmux 통합 명령어

사용법: t [command|session-name]

프로필:
  dev [name]          개발 환경 (nvim + Claude/Codex + Shell)

세션 관리:
  ls, list            세션 목록
  a, attach [name]    세션 연결 (fzf 선택)
  k, kill <name>      세션 종료
  ka, kill-all        tmux 서버 종료

예시:
  t dev               현재 디렉토리명으로 개발 세션 시작
  t dev myproject     'myproject' 개발 세션
  t mywork            'mywork' 세션 시작/연결
EOF
            ;;

        # 기본: 세션 이름 또는 fzf 선택
        *)
            if [[ -n "$cmd" ]]; then
                if tmux has-session -t "$cmd" 2>/dev/null; then
                    tmux attach -t "$cmd"
                else
                    tmux new-session -s "$cmd"
                fi
            else
                if command -v fzf > /dev/null 2>&1; then
                    local sessions=$(tmux list-sessions -F '#S' 2>/dev/null)
                    if [[ -n "$sessions" ]]; then
                        local choice=$(echo -e "$sessions\n[새 세션]" | fzf --prompt="선택: ")
                        if [[ "$choice" == "[새 세션]" ]]; then
                            tmux new-session
                        elif [[ -n "$choice" ]]; then
                            tmux attach -t "$choice"
                        fi
                    else
                        tmux new-session
                    fi
                else
                    tmux
                fi
            fi
            ;;
    esac
}

# t 자동완성
_t_completion() {
    local -a commands
    commands=(
        'dev:개발 환경 (nvim + AI + Shell)'
        'ls:세션 목록'
        'list:세션 목록 (ls와 동일)'
        'a:세션 연결'
        'attach:세션 연결 (a와 동일)'
        'k:세션 종료'
        'kill:세션 종료 (k와 동일)'
        'ka:tmux 서버 종료'
        'kill-all:tmux 서버 종료 (ka와 동일)'
        'help:도움말'
    )

    if (( CURRENT == 2 )); then
        _describe 'command' commands
        local sessions=(${(f)"$(tmux list-sessions -F '#S' 2>/dev/null)"})
        [[ -n "$sessions" ]] && _describe 'session' sessions
    elif (( CURRENT == 3 )); then
        case "${words[2]}" in
            a|attach|k|kill)
                local sessions=(${(f)"$(tmux list-sessions -F '#S' 2>/dev/null)"})
                [[ -n "$sessions" ]] && _describe 'session' sessions
                ;;
        esac
    fi
}
compdef _t_completion t

# ----------------------------------------------------------------------------
# AI CLI (tmux 자동 세션)
# tmux 밖에서 실행하면 자동으로 tmux 세션 안에서 시작
# ----------------------------------------------------------------------------
_ai_in_tmux() {
    local name="$1"; shift
    local cmd="$1"; shift
    if [[ -n "$TMUX" ]]; then
        command $cmd "$@"
    else
        if tmux has-session -t "$name" 2>/dev/null; then
            tmux attach -t "$name"
        else
            tmux new-session -s "$name" "$cmd" "$@"
        fi
    fi
}

claude()  { _ai_in_tmux claude  claude  "$@"; }
codex()   { _ai_in_tmux codex   codex   "$@"; }
gemini()  { _ai_in_tmux gemini  gemini  "$@"; }

# 단축 (모두 tmux 자동 세션)
cc()  { _ai_in_tmux claude  claude  "$@"; }
ccp() { _ai_in_tmux claude  claude  -p "$@"; }
ccr() { _ai_in_tmux claude  claude  --resume "$@"; }
ccd() { _ai_in_tmux claude  claude  --dangerously-skip-permissions "$@"; }
cx()  { _ai_in_tmux codex   codex   "$@"; }
gmn() { _ai_in_tmux gemini  gemini  "$@"; }

# ----------------------------------------------------------------------------
# 개발 도구 별칭
# ----------------------------------------------------------------------------
alias dev='cd ~/SynologyDrive/_devspace'

# TUI 도구
alias lg="lazygit"
alias ld="lazydocker"

# 검색 도구 (ripgrep, fd)
alias rg="rg --smart-case"
alias f="fd"

# Git 별칭
alias g="git"
alias gs="git status"
alias ga="git add"
alias gc="git commit"
alias gp="git push"
alias gl="git pull"
alias gd="git diff"
alias gco="git checkout"
alias gb="git branch"
alias glog="git log --oneline --graph --decorate"

# 일반 별칭
alias ll="ls -alh"
alias la="ls -A"
alias l="ls -CF"
alias ..="cd .."
alias ...="cd ../.."
alias ....="cd ../../.."

# 에디터
alias v="vim"

# ============================================================================
# 함수 (Functions)
# ============================================================================

# ----------------------------------------------------------------------------
# 프로젝트 디렉토리로 이동 후 AI 세션 시작
# 사용법: proj <project-name>
# ----------------------------------------------------------------------------
proj() {
    local project_dir="$HOME/SynologyDrive/_devspace/$1"

    if [[ -d "$project_dir" ]]; then
        cd "$project_dir"
        t dev "$1"
    else
        echo "프로젝트를 찾을 수 없습니다: $project_dir"
        echo "사용 가능한 프로젝트:"
        ls -1 "$HOME/SynologyDrive/_devspace/" | head -20
    fi
}

# ----------------------------------------------------------------------------
# Claude와 Codex 동시 실행 (tmux 분할)
# ----------------------------------------------------------------------------
dual_ai() {
    if [[ -n "$TMUX" ]]; then
        tmux split-window -h "codex"
        claude
    else
        echo "tmux 세션 내에서 실행해주세요."
        echo "시작하려면: t dev"
    fi
}

# ----------------------------------------------------------------------------
# devhelp: 통합 도움말 시스템
# ----------------------------------------------------------------------------
devhelp() {
    local cmd="${1:-}"
    local help_script="$DOTFILES_DIR/bin/devhelp"

    if [[ -x "$help_script" ]]; then
        "$help_script" "$@"
    else
        echo "devhelp 스크립트를 찾을 수 없습니다."
        echo "dotfiles를 다시 설치해주세요: $DOTFILES_DIR/install.sh link"
    fi
}

# ----------------------------------------------------------------------------
# 빠른 키바인딩 참조
# ----------------------------------------------------------------------------
keys() {
    devhelp keys
}

# ============================================================================
# tmux 자동 시작 (Ghostty에서만)
# ============================================================================
if [[ "$TERM" == "xterm-ghostty" ]] && [[ -z "$TMUX" ]] && [[ -z "$CLAUDE_CODE" ]]; then
    # 자동 시작을 원하면 아래 주석 해제
    # tmux new-session -A -s main
    :
fi

# ----------------------------------------------------------------------------
# 성능 측정 (종료) 및 표시
# ----------------------------------------------------------------------------
zsh_end_time=$EPOCHREALTIME
zsh_load_time=$(echo "($zsh_end_time - $zsh_start_time) * 1000" | bc)

if command -v gum > /dev/null 2>&1 && [[ -z "$CLAUDE_CODE" ]]; then
    echo ""
    gum style \
        --border rounded \
        --border-foreground 240 \
        --padding "0 2" \
        --foreground 51 \
        --width $((COLUMNS - 10)) \
        --align center \
        --margin "0 auto" \
        "zsh loaded in ${zsh_load_time}ms | devhelp for help"
fi
